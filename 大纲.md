# Global Verifier 大纲

## 系统概述
这是一个一体化系统，用于对比不同 LLM 模型在网页环境中的表现。

### 核心组件
1. **Agent（执行模块）**
   - 与环境交互，执行动作
   - 需要时查询 Experience Base 获取经验
   - 将执行结果提交给 Experience Base

2. **Experience Base（知识库）**
   - 存储经验知识 `(s_t, a, s_{t+1})`
   - 提供经验查询接口
   - 检测冲突并安排验证

3. **Adapter（适配器）**
   - 不同环境的适配层
   - 将原始状态转换为统一格式

## 工作流程

### Agent 执行流程
```
Agent 执行时：
1. 遇到新状态 s_t → 查询 Experience Base → 获取相关经验（如有）
2. 执行动作 a
3. 观察新状态 s_{t+1}
4. 将 (s_t, a, s_{t+1}) 提交给 Experience Base
5. Experience Base 检查是否与现有知识冲突
```

### Experience Base 流程
```
接收到新经验 (s_t, a, s_{t+1})：
1. 检查与现有知识是否冲突
2. 如冲突 → 记录待验证队列
3. 如不冲突 → 存储经验
4. 等待 Agent 空闲时，验证冲突项
```

## 环境

### 目标环境
1. **WebShop** [https://github.com/princeton-nlp/WebShop] - 电商购物环境
2. **WebArena** [https://webarena.dev/] - 通用网页操作环境
3. **未来扩展** - 非浏览器环境

### 环境要求
- 每个环境需要实现 Adapter，统一状态表示
- 支持多任务并行（方便验证冲突）

## Agent 模块

### 1. Explorer 类
```python
class Explorer:
    """核心执行器"""
    def __init__(self, explorer_model, experience_base, adapter):
        self.model = explorer_model  # LLM 模型
        self.exp_base = experience_base  # 经验库
        self.adapter = adapter  # 环境适配器
    
    def explore(self, goal):
        """执行探索任务"""
        # 1. 查询相关经验
        # 2. 与环境交互
        # 3. 存储新经验
```

### 2. Explorer Model
- **Meta-Llama-3-8B-Instruct** [/home/xingkun/local_model/Meta-Llama-3-8B-Instruct]
- **Qwen2.5-7B-Instruct** [/home/xingkun/local_model/Qwen2.5-7B-Instruct]
- **Qwen3-8B** [/home/xingkun/local_model/Qwen3-8B]

### 3. Adapter
```python
class BaseAdapter:
    """统一环境适配器接口"""
    def adapt_state(self, raw_state) -> State:
        """将原始状态转换为统一格式"""
    
    def adapt_action(self, action) -> str:
        """将动作转换为环境可理解的格式"""
```

具体实现：
- `WebshopAdapter` - 适配 WebShop 环境
- `WebarenaAdapter` - 适配 WebArena 环境

## Experience Base

### 功能
1. **经验存储** - 存储已验证的经验 `(s_t, a, s_{t+1})`
2. **经验查询** - 根据状态 s_t 找到相似经验
3. **冲突检测** - 检测新旧经验是否矛盾
4. **验证调度** - 安排冲突经验的验证实验

### 经验格式
```python
Experience = {
    "s_t": "初始状态描述",      # 文本或 embedding
    "a": "执行的动作",          # 动作描述
    "s_t1": "新状态描述",       # 结果状态
    "env": "环境类型",          # webshop/webarena
    "confidence": 0.95,         # 置信度
    "metadata": {...}           # 元数据
}
```

### 关键技术问题

#### 1. 如何判断经验相关？
- **方案 A**：文本相似度（TF-IDF, BLEU）
- **方案 B**：Embedding 相似度（BERT, Sentence-BERT）
- **方案 C**：结构化特征相似度

#### 2. 如何判断经验冲突？
- 同一 `(s_t, a)` 得到不同的 `s_{t+1}`
- 需要定义"相同"的含义（exact match vs fuzzy match）

#### 3. 验证机制
- 冲突时，重新执行相同 `(s_t, a)` 多次
- 统计多次实验的结果分布
- 判断哪个经验更可靠

## 系统架构

```
┌─────────────────────────────────────┐
│           Explorer Agent            │
│  ┌────────────┐    ┌──────────────┐ │
│  │ LLM Model  │    │   Experience │ │
│  │ (Qwen/     │◄──►│   Base       │ │
│  │ Llama3)    │    │              │ │
│  └────────────┘    └──────────────┘ │
└──────────┬──────────────────────────┘
           │
           │ via Adapter
           ▼
┌─────────────────────────────────────┐
│            Environment               │
│  (WebShop / WebArena / ...)         │
└─────────────────────────────────────┘
```

## 待解决问题

### 关键问题
1. **状态表示** - 如何表示环境状态？
   - 纯文本描述
   - DOM 树结构
   - Screenshot embedding
   - 混合方法

2. **经验相似度** - 如何定义"相似"？
   - 两个状态何时算相似？
   - 两个动作何时算相同？

3. **冲突定义** - 什么是"冲突"？
   - 确定性环境：必然冲突
   - 随机环境：如何判定？

4. **验证成本** - 如何平衡验证成本与系统性能？
   - 什么时候值得验证？
   - 验证多少次合适？

### 工程问题
1. **模块化设计** - 如何方便切换模型和环境？
2. **性能优化** - 经验库查询效率
3. **可扩展性** - 支持新环境和新模型

## 实施计划

### Phase 1: 基础框架（当前）
- ✅ 模型加载
- ✅ 环境集成（WebShop）
- ⏳ Experience Base 基础框架

### Phase 2: 核心功能
- ⏳ Adapter 实现
- ⏳ 经验存储和查询
- ⏳ 冲突检测机制

### Phase 3: 高级功能
- ⏳ LLM 辅助经验管理
- ⏳ 多环境支持
- ⏳ 性能优化

## 参考资源
- WebShop: https://github.com/princeton-nlp/WebShop
- WebArena: https://webarena.dev/
